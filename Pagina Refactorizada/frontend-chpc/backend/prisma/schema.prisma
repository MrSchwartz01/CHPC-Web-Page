// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum OrderStatus {
  PENDING
  PAID
  SHIPPED
  COMPLETED
  CANCELLED
}

enum PaymentMethod {
  CASH
  CARD
  TRANSFER
}

model User {
  id                Int       @id @default(autoincrement())
  nombre            String
  apellido          String
  username          String    @unique
  email             String    @unique
  password          String
  telefono          String?
  direccion         String?
  rol               String    @default("cliente")
  refresh_token     String?
  intentos_fallidos Int       @default(0)
  bloqueado_hasta   DateTime?
  ultimo_acceso     DateTime?
  fecha_creacion    DateTime  @default(now())
  fecha_actualizacion DateTime  @updatedAt

  orders            Order[]
  wishlistItems     WishlistItem[]
  serviceOrders     ServiceOrder[]
  permisosTemporales PermisoTemporal[]

  @@map("usuarios")
}

model Product {
  id             Int     @id @default(autoincrement())
  nombre_producto String
  descripcion     String
  precio          Float
  stock           Int
  imagen_url      String
  marca           String?
  color           String?
  erpId           String? @unique

  wishlistItems   WishlistItem[]
  serviceOrders   ServiceOrder[]
  productImages   ProductImage[]
  banners         Banner[]
  promotions      Promotion[]

  @@map("productos")
}

model Banner {
  id          Int      @id @default(autoincrement())
  titulo      String
  imagen_url  String
  producto_id Int?     @map("producto_id")
  producto    Product? @relation(fields: [producto_id], references: [id], onDelete: SetNull)

  @@map("banners")
  @@index([producto_id])
}

model Order {
  id               Int          @id @default(autoincrement())
  codigo           String       @unique
  userId           Int
  user             User         @relation(fields: [userId], references: [id])

  totalItems       Int
  subtotal         Float
  descuento        Float        @default(0)
  total            Float

  status           OrderStatus  @default(PENDING)
  paymentMethod    PaymentMethod
  paymentRef       String?

  nombre_cliente   String
  email_cliente    String
  telefono         String?
  direccion_envio  String

  observaciones    String?

  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  items            OrderItem[]

  @@map("ordenes")
}

model OrderItem {
  id         Int    @id @default(autoincrement())
  orderId    Int
  order      Order  @relation(fields: [orderId], references: [id])

  productId  Int
  nombre     String
  precio     Float
  cantidad   Int
  total      Float

  @@map("orden_items")
}

model WishlistItem {
  id        Int      @id @default(autoincrement())
  userId    Int
  productId Int
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([userId, productId], name: "user_product_unique")
  @@map("wishlist_items")
}

enum ServiceOrderStatus {
  PENDIENTE
  EN_PROCESO
  COMPLETADO
  CANCELADO
}

model ServiceOrder {
  id                  Int                @id @default(autoincrement())
  userId              Int
  productId           Int?
  descripcion_problema String
  estado_equipo       String?
  numero_serie        String?
  estado              ServiceOrderStatus @default(PENDIENTE)
  fecha_creacion      DateTime           @default(now())
  fecha_actualizacion DateTime           @updatedAt

  user                User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  product             Product?           @relation(fields: [productId], references: [id])

  @@map("ordenes_servicio")
}

model SyncLog {
  id          Int      @id @default(autoincrement())
  entityName  String   @unique
  lastSync    DateTime
  status      String
  updatedAt   DateTime @updatedAt
}

model ProductImage {
  id                 Int      @id @default(autoincrement())
  producto_id        Int
  ruta_imagen        String   @db.VarChar(500)
  nombre_archivo     String?  @db.VarChar(255)
  tipo_archivo       String?  @db.VarChar(50)
  tamano_archivo     Int?
  es_principal       Boolean  @default(false)
  orden              Int      @default(0)
  version_optimizada Boolean  @default(false)
  fecha_subida       DateTime @default(now())
  
  producto           Product  @relation(fields: [producto_id], references: [id], onDelete: Cascade)
  
  @@map("imagenes")
  @@index([producto_id])
  @@index([es_principal])
  @@index([orden])
}

model Promotion {
  id                Int      @id @default(autoincrement())
  producto_id       Int
  porcentaje_descuento Float
  fecha_inicio      DateTime
  fecha_fin         DateTime
  activa            Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  producto          Product  @relation(fields: [producto_id], references: [id], onDelete: Cascade)
  
  @@map("promociones")
  @@index([producto_id])
  @@index([activa])
  @@index([fecha_inicio, fecha_fin])
}

model SiteConfig {
  id         Int      @id @default(autoincrement())
  clave      String   @unique
  valor      String
  updatedAt  DateTime @updatedAt
  
  @@map("configuracion_sitio")
}

model PermisoTemporal {
  id              Int      @id @default(autoincrement())
  user_id         Int
  tipo_permiso    String   // 'banners', 'promociones', 'logo', 'all'
  fecha_inicio    DateTime @default(now())
  fecha_expiracion DateTime
  activo          Boolean  @default(true)
  otorgado_por    String?  // username del admin que otorgó el permiso
  razon           String?  // razón del permiso temporal
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  usuario         User     @relation(fields: [user_id], references: [id], onDelete: Cascade)
  
  @@map("permisos_temporales")
  @@index([user_id])
  @@index([activo])
  @@index([fecha_expiracion])
}
